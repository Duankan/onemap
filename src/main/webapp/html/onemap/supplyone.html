<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../theme/default/easyui.css" />
    <link href="../../css/icon.css" rel="stylesheet" />
    <link href="../../css/app.css" rel="stylesheet" />
    <link href="../../css/icon.css" rel="stylesheet" />
    <link href="../../css/main.css" rel="stylesheet" />
    <link href="../../css/ktw.form.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <script src="../../js/echarts.js"></script>
    <script src="../../js/echarts.min.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/highcharts-3d.js"></script>
    <script src="../../js/ktw.ui.js"></script>
    <script>
        var Ktw = window.top.window.ktw;
        var xarray = [];
        var dataGrid;
        var winWidth;
        var result = [];
        var way;
        var ctr;//等待条
        var myChart;
        var datamodules = [];
        var datas;
        $(window).ready(function () {
            //清除屏幕
            Ktw.ClearFinal();
            ctr = new ktw.UCWaitBox({
                Parent: $(".Content")
            });
            way = $(".active", ".stc-nav")[0].innerText;
            winWidth = $(window).width() >= 1000 ? $(window).width() : 1000;
            var stype = "area";
            initTarget();
            initDataGrid();
            var myDate = new Date();
            var starttime = myDate.getFullYear() + "-01-01", endtime = myDate.getFullYear() + "-" + (myDate.getMonth() + 1) + "-" + myDate.getDate();
            $('#starttime').datebox('setValue', starttime);
            $('#endtime').datebox('setValue', endtime);
            $("#field").prop("$this").SetSelectedItem('供应总面积');
            Statistics();
            initCharts("Columnar");
            $("#statictable").hide();
            windowresize();
            $(".Button[operatetype]").click(function (evt) {
                var type = $(this).attr("operatetype");
                if (type == "Statistics") Statistics(stype);
                if (type == "Export") exportData(evt);
            });
            var syearComBox = $("#startyear").prop('$this');
            var eyearComBox = $("#endyear").prop('$this');
            var countyarea = $("#area").prop("$this");
            var quarterComBox = $("#quarter").prop("$this");
            var fieldComBox = $("#field").prop('$this')
            syearComBox.SetVisible(false);
            eyearComBox.SetVisible(false);
            quarterComBox.SetVisible(false);
            var date = [], date1 = [];
            for (var i = 2008; i <= myDate.getFullYear() ; i++) {
                date.push(i);
            }
            for (var i = 1; i <= 12; i++) {
                date1.push(i + "月");
            }
            var byarea = [datas, starttime, endtime];
            var byyear = [datas[0], date[0], date[date.length - 1]];
            var byquarter = [datas[0], date[date.length - 1], date[date.length - 1], ["第一季度", "第二季度", "第三季度", "第四季度"]];
            $("#byarea").bind("click", function (e) {
                $("#byarea").addClass("active");
                $("#time").show();
                syearComBox.SetVisible(false);
                eyearComBox.SetVisible(false);
                quarterComBox.SetVisible(false);
                countyarea.listBox.MultiSelect = true;
                if ($("#byyear").hasClass("active")) {
                    byyear = [$("#area").prop("$this").GetText(), $("#startyear").prop("$this").GetText(), $("#endyear").prop("$this").GetText()];
                    $("#byyear").removeClass("active");
                }
                if ($("#byquarter").hasClass("active")) {
                    byquarter = [$("#area").prop("$this").GetText(), $("#startyear").prop("$this").GetText(), $("#endyear").prop("$this").GetText(), $("#quarter").prop("$this").GetText().split("，")];
                    $("#byquarter").removeClass("active");
                }
                $("#area").prop("$this").SetSelectedItem(byarea[0]);
                $('#starttime').datebox('setValue', byarea[1]);
                $('#endtime').datebox('setValue', byarea[2]);
                stype = "area";
                Statistics(stype);
                fieldComBox.SetData(["供应总面积", "供应总宗数", "供应所得总价款", "商服用地", "工业仓储用地", "采矿用地", "普通商品住房用地", "经济适用住房", "廉租住房用地", "高档住宅用地", "其他住宅用地", "公共管理与公共服务用地", "特殊用地", "交通运输用地", "水域及水利设施用地", "其他用地"]);
                way = "按行政区"
            });
            $("#byyear").bind("click", function (e) {
                $("#byyear").addClass("active");
                syearComBox.SetVisible(true);
                syearComBox.SetData(date);
                eyearComBox.SetVisible(true);
                eyearComBox.SetData(date);
                quarterComBox.SetVisible(false);
                $("#time").hide();
                if ($("#byarea").hasClass("active")) {
                    byarea = [$("#area").prop("$this").GetText().split("，"), $("#starttime").data().combo.previousText, $("#endtime").data().combo.previousText];
                    $("#byarea").removeClass("active");
                }
                if ($("#byquarter").hasClass("active")) {
                    byquarter = [$("#area").prop("$this").GetText(), $("#startyear").prop("$this").GetText(), $("#endyear").prop("$this").GetText(), $("#quarter").prop("$this").GetText().split("，")];
                    $("#byquarter").removeClass("active");
                }
                $("#area").prop("$this").SetSelectedItem(byyear[0]);
                $("#startyear").prop("$this").SetValue(byyear[1]);
                $("#endyear").prop("$this").SetValue(byyear[2]);
                countyarea.listBox.MultiSelect = false;
                stype = "year";
                Statistics(stype);
                fieldComBox.SetData(["供应总面积", "供应总宗数", "供应所得总价款"]);
                way = "按年份"
            });
            $("#byquarter").bind("click", function (e) {
                $("#byquarter").addClass("active");
                syearComBox.SetVisible(true);
                syearComBox.SetData(date);
                eyearComBox.SetVisible(true);
                eyearComBox.SetData(date);
                quarterComBox.SetVisible(true);
                quarterComBox.SetData(["第一季度", "第二季度", "第三季度", "第四季度"]);
                $("#time").hide();
                if ($("#byarea").hasClass("active")) {
                    byarea = [$("#area").prop("$this").GetText().split("，"), $("#starttime").data().combo.previousText, $("#endtime").data().combo.previousText];
                    $("#byarea").removeClass("active");
                }
                if ($("#byyear").hasClass("active")) {
                    byyear = [$("#area").prop("$this").GetText(), $("#startyear").prop("$this").GetText(), $("#endyear").prop("$this").GetText()];
                    $("#byyear").removeClass("active");
                }
                $("#area").prop("$this").SetSelectedItem(byquarter[0]);
                $("#startyear").prop("$this").SetValue(byquarter[1]);
                $("#endyear").prop("$this").SetValue(byquarter[2]);
                $("#quarter").prop("$this").SetSelectedItem(byquarter[3]);
                countyarea.listBox.MultiSelect = false;
                stype = "quarter";
                Statistics(stype);
                fieldComBox.SetData(["供应总面积", "供应总宗数", "供应所得总价款"]);
                way = "按季度"
            });
            $("#tab").bind("click", function (e) {
                if ($("#tab").hasClass("active")) {
                    $("#tab").removeClass("active");
                    $("#statictable").hide();
                }
                else {
                    $("#tab").addClass("active");
                    $("#statictable").show();
                }
                windowresize();
            });
            $("#map").bind("click", function (e) {
                if ($("#map").hasClass("active")) {
                    $("#map").removeClass("active");
                    $("#chartModule").hide();
                }
                else {
                    $("#map").addClass("active");
                    $("#chartModule").show();
                }
                windowresize();
            });
            var fieldComBox = $("#field").prop('$this');
            fieldComBox.bind("onSelectChanged", function () {
                initCharts();
            })
        })
        function windowresize(t) {
            if ($("#searchModule").find("br").length > 0) {
                $("#newline").remove();
            }
            if (t != null) Ktw.App.MenuInit.currentParent.Layout();
            if ($("#map").hasClass("active")) {
                if ($("#tab").hasClass("active")) {
                    if (t == null) Ktw.App.MenuInit.currentParent.SetSize(1200, 600);
                    document.getElementById("topport").style.height = (Ktw.App.MenuInit.currentParent.Height - 70) * 0.49 + "px";
                    document.getElementById("searchModule").style.height = 40 + "px";
                    document.getElementById("statictable").style.height = ((Ktw.App.MenuInit.currentParent.Height - 70) * 0.49 - 47) + "px";
                    document.getElementById("chartModule").style.height = (Ktw.App.MenuInit.currentParent.Height - 70) * 0.49 + "px";
                    $("#static").css({ "top": -5, "right": 90 });
                    $("#export").css({ "top": -5, "right": 10 });
                    $("#topport").css("min-width", 1000);
                    $("#chartModule").css("min-width", 1000);
                    $(".stc-nav").css("min-width", 1000);
                    myChart.resize();
                    initDataGrid();
                    return;
                }
                else {
                    if (t == null) Ktw.App.MenuInit.currentParent.SetSize(550, 450);
                    document.getElementById("topport").style.height = 75 + "px";
                    document.getElementById("searchModule").style.height = 75 + "px";
                    document.getElementById("chartModule").style.height = (Ktw.App.MenuInit.currentParent.Height - 175) + "px";
                    $("#topport").css("min-width", 500);
                    $(".stc-nav").css("min-width", 500);
                    $("#chartModule").css("min-width", 500);
                    var brs = $("#searchModule").find("br");
                    if (brs.length <= 0) {
                        $("<br id='newline'/>").insertBefore("#newline1");
                    }
                    $("#static").css({ "top": -5, "right": 10 });
                    $("#export").css({ "top": 30, "right": 10 });
                    myChart.resize();
                    initDataGrid();
                    return;
                }
            }
            else if ($("#tab").hasClass("active")) {
                document.getElementById("topport").style.height = 40 + "px";
                document.getElementById("searchModule").style.height = 40 + "px";
                if (t == null) Ktw.App.MenuInit.currentParent.SetSize(1200, 350);
                document.getElementById("statictable").style.height = (Ktw.App.MenuInit.currentParent.Height - 125) + "px";
                document.getElementById("chartModule").style.height = 0 + "px";
                $("#static").css({ "top": -5, "right": 90 });
                $("#export").css({ "top": -5, "right": 10 });
                $("#topport").css("min-width", 1000);
                $("#chartModule").css("min-width", 1000);
                $(".stc-nav").css("min-width", 1000);
                myChart.resize();
                initDataGrid();
                return;
            }
            else {
                $("#map").addClass("active");
                $("#chartModule").show();
                windowresize();
            }
        }
        function initCharts() {
            var tag = 0;
            var currentresult = result[0], currentparam;
            var currentdata = [];
            var historyoption;
            myChart = echarts.init(document.getElementById('chart'));
            //var PieChart = echarts.init(document.getElementById('Piechart'));
            myChart.clear();
            //PieChart.clear();
            var yAxis = [
                       {
                           name: '单位/公顷',
                           type: 'value',
                       },
            ];
            var toolbox = {
                show: true,
                left: 20,
                feature: {
                    saveAsImage: { type: 'png' }
                }
            };

            var legendarray = [], series = [];
            var field = $("#field").prop("$this").GetText();
            var data1 = [], d = [], pielegend = [];
            if (field == "") field = "供应总面积";
            //var pieseries = [{
            //    type: 'pie',
            //    name: '情况统计',
            //    radius: '45%',
            //    center: ['50%', '60%'],
            //    data: d
            //}];
            if (way == "按行政区" || way == "") {
                legendarray.push(field);
                switch (field) {
                    case "供应总宗数": for (var i = 0; i < result.length; i++) data1.push(result[i].mJianCount);
                        yAxis[0].name = '单位/个';
                        break;
                    case "供应所得总价款": for (var i = 0; i < result.length; i++) data1.push(result[i].mCrjk); yAxis[0].name = '单位/万元'; break;
                    case "商服用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mSf); break;
                    case "工业仓储用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mGcc); break;
                    case "采矿用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mCk); break;
                    case "普通商品住房用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mPtzf); break;
                    case "经济适用住房": for (var i = 0; i < result.length; i++) data1.push(result[i].mJjsyf); break;
                    case "廉租住房用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mLzzf); break;
                    case "高档住宅用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mGdzz); break;
                    case "其他住宅用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mQtzz); break;
                    case "公共管理与公共服务用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mGggf); break;
                    case "特殊用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mTsyd); break;
                    case "交通运输用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mJtys); break;
                    case "水域及水利设施用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mSySl); break;
                    case "其他用地": for (var i = 0; i < result.length; i++) data1.push(result[i].mQtyd); break;
                    default: for (var i = 0; i < result.length; i++) data1.push(result[i].mGyMj); break;
                }
                series = [{
                    name: field,
                    type: "bar",
                    data: data1
                }];
                for (var i = 0; i < result.length; i++) {
                    d.push({ value: data1[i], name: result[i].XZQMC })
                    pielegend.push(result[i].XZQMC);
                };
            }
            if (way == "按年份" || way == "按季度") {
                if (field == "供应总宗数") {
                    yAxis[0].name = '单位/个';
                    legendarray = ["供应总宗数"]
                    for (var i = 0; i < result.length; i++) {
                        data1.push(result[i].mJianCount);
                    }
                    //增长率
                    //data6 = [0];
                    //for (var i = 1; i < result.length; i++) data6.push((result[i].mJianCount - result[i - 1].mJianCount) / result[i - 1].mJianCount * 100);
                    d.push({ value: data1[0], name: "供应总宗数" });
                    pielegend = ["供应总宗数"]
                    var series = [{
                        name: "供应总宗数",
                        type: "bar",
                        data: data1
                    }];
                }
                else if (field == "供应所得总价款") {
                    yAxis[0].name = '单位/万元';
                    legendarray = ["供应所得总价款"]
                    for (var i = 0; i < result.length; i++) {
                        data1.push(result[i].mCrjk);
                    }
                    //增长率
                    //data6 = [0];
                    //for (var i = 1; i < result.length; i++) data6.push((result[i].mCrjk - result[i - 1].mCrjk) / result[i - 1].mCrjk * 100);
                    d.push({ value: data1[0], name: "供应所得总价款" });
                    pielegend = ["供应所得总价款"]
                    var series = [{
                        name: "供应所得总价款",
                        type: "bar",
                        data: data1
                    }];
                }
                else {
                    yAxis[0].name = '单位/万元';
                    toolbox = {
                        show: true,
                        left: 20,
                        feature: {
                            myTool1: {
                                show: true,
                                title: '返回上一步',
                                icon: 'image://http://echarts.baidu.com/images/favicon.png',
                                onclick: function () {
                                    if (tag == 0) { Ktw.Alert("已经到第一层"); return; }
                                    myChart.clear();
                                    tag--;
                                    myChart.setOption(historyoption);
                                    chartOption = $.extend(true, {}, historyoption);
                                    myChart.trigger("click", currentparam);
                                },
                            },
                            saveAsImage: { type: 'png' }
                        }
                    };
                    legendarray = ["商服用地", "工矿仓储用地", "住宅用地", "其他用地"]
                    var data2 = [], data3 = [], data4 = [];
                    for (var i = 0; i < result.length; i++) {
                        data1.push(result[i].mSf);
                        var gkcc = result[i].mGcc + result[i].mCk;
                        if (parseInt(gkcc) != gkcc && gkcc.toString().split(".")[1].length > 4) gkcc = parseFloat(gkcc.toFixed(4));
                        var zzyd = result[i].mPtzf + result[i].mJjsyf + result[i].mLzzf + result[i].mGdzz + result[i].mQtzz
                        if (parseInt(zzyd) != zzyd && zzyd.toString().split(".")[1].length > 4) zzyd = parseFloat(zzyd.toFixed(4));
                        var qtyd = result[i].mGggf + result[i].mTsyd + result[i].mJtys + result[i].mSySl + result[i].mQtyd
                        if (parseInt(qtyd) != qtyd && qtyd.toString().split(".")[1].length > 4) qtyd = parseFloat(qtyd.toFixed(4));
                        data2.push(gkcc);
                        data3.push(zzyd);
                        data4.push(qtyd);
                    }
                    //增长率
                    //data6 = [0];
                    //for (var i = 1; i < result.length; i++) data6.push((result[i].mGyMj - result[i - 1].mGyMj) / result[i - 1].mGyMj * 100);
                    //饼状图数据
                    //d.push({ value: data1[0], name: "商服用地" }, { value: data2[0], name: "工矿仓储用地" }, { value: data3[0], name: "住宅用地" }, { value: data4[0], name: "其他用地" })
                    pielegend = ["商服用地", "工矿仓储用地", "住宅用地", "其他用地"]
                    var series = [{
                        name: "商服用地",
                        type: "bar",
                        data: data1
                    }, {
                        name: "工矿仓储用地",
                        type: "bar",
                        data: data2
                    }, {
                        name: "住宅用地",
                        type: "bar",
                        data: data3
                    }, {
                        name: "其他用地",
                        type: "bar",
                        data: data4
                    }];

                }
            }
            chartOption = {
                //title: {
                //    text: '供地' + field + '情况统计     (单位:公顷)',
                //    x: 'center'
                //},
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                        type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                    }
                },

                legend: {
                    x: 'center',
                    top: 30,
                    data: legendarray
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    top: 70,
                    containLabel: true
                },
                xAxis: [
                   {
                       type: 'category',
                       data: xarray,
                       axisLabel: {
                           interval: 0,//横轴信息全部显示
                           rotate: 45
                       }
                   }
                ],
                yAxis: yAxis,
                toolbox: toolbox,
                series: series
            };

            myChart.setOption(chartOption);
            myChart.off('dblclick');//解除双击绑定事件
            //钻取
            myChart.on('dblclick', function (param) {
                currentparam = param;
                data1 = [], data2 = [], data3 = [], data4 = [];
                var data5 = [];
                if (param.seriesName == "工矿仓储用地") {
                    historyoption = historyoption = $.extend(true, {}, chartOption);;
                    name1 = "工业仓储用地";
                    name2 = "采矿用地";
                    chartOption.series.splice(2, 2);
                    legendarray = [name1, name2];
                    for (var i = 0; i < result.length; i++) {
                        data1.push(result[i].mGcc);
                        data2.push(result[i].mCk);
                    }
                } else if (param.seriesName == "住宅用地") {
                    historyoption = historyoption = $.extend(true, {}, chartOption);;
                    if (chartOption.series.length > 3)
                        name1 = "普通商品住房用地";
                    name2 = "经济适用住房";
                    name3 = "廉租住房用地";
                    name4 = "高档住宅用地";
                    name5 = "其他住宅用地";
                    legendarray = [name1, name2, name3, name4, name5];
                    for (var i = 0; i < result.length; i++) {
                        data1.push(result[i].mPtzf);
                        data2.push(result[i].mJjsyf);
                        data3.push(result[i].mLzzf);
                        data4.push(result[i].mGdzz);
                        data5.push(result[i].mQtzz);
                    }
                } else if (param.seriesName == "其他用地") {
                    historyoption = historyoption = $.extend(true, {}, chartOption);;
                    if (chartOption.series.length > 3)
                        name1 = "公共管理与公共服务用地";
                    name2 = "特殊用地";
                    name3 = "交通运输用地";
                    name4 = "水域及水利设施用地";
                    name5 = "其他用地";
                    legendarray = [name1, name2, name3, name4, name5];
                    for (var i = 0; i < result.length; i++) {
                        data1.push(result[i].mGggf);
                        data2.push(result[i].mTsyd);
                        data3.push(result[i].mJtys);
                        data4.push(result[i].mSySl);
                        data5.push(result[i].mQtyd);
                    }
                } else { return; }
                if (param.seriesName == "住宅用地" || param.seriesName == "其他用地") {
                    chartOption.series.splice(2, 0, {});
                    chartOption.series[2].data = data3;
                    chartOption.series[2].name = name3;
                    chartOption.series[2].type = "bar";
                    chartOption.series[3].data = data4;
                    chartOption.series[3].name = name4;
                    chartOption.series[3].type = "bar";
                    chartOption.series[4].data = data5;
                    chartOption.series[4].name = name5;
                    chartOption.series[4].type = "bar";
                }
                chartOption.legend.data = legendarray;
                chartOption.series[0].name = name1;
                chartOption.series[1].name = name2;
                chartOption.series[0].data = data1;
                chartOption.series[1].data = data2;
                myChart.clear();
                myChart.setOption(chartOption);
                myChart.trigger("click", param);
                tag++;
            });
            window.onresize = function () {
                Ktw.App.MenuInit.currentParent.Layout();
                windowresize("a");
                winWidth = $(window).width();
                var height = $(window).height();
                if (winWidth >= 1000) {
                    winWidth = window.innerWidth;
                    initDataGrid();
                    $(".Content").css({
                        "width": winWidth,
                        "overflow": "hidden"
                    });
                    myChart.resize();
                }
                else {
                    $(".Content").css({
                        "width": winWidth,
                        "overflow-x": "auto",
                    });
                    winWidth = 1000;
                    initDataGrid();
                    myChart.resize();
                }
            }
        }
        //验证统计必填条件
        function validation() {
            var startyear = $("#startyear").prop("$this").GetText();
            if ($("#startyear").prop("$this").Visible == true && startyear == "") {
                Ktw.Alert("请选择起始年份!");
                return false;
            }
            var endyear = $("#endyear").prop("$this").GetText();
            if ($("#endyear").prop("$this").Visible == true && endyear == "") {
                Ktw.Alert("请选择终止年份!");
                return false;
            }
            var quarter = $("#quarter").prop("$this").GetText();
            if ($("#quarter").prop("$this").Visible == true && quarter == "") {
                Ktw.Alert("请选择季度!");
                return false;
            }
            return true;
        }
        function Statistics(type) {
            var flag = "area";
            var myDate = new Date();
            var starttime = myDate.getFullYear() + "-01-01", endtime = myDate.getFullYear() + "-" + (myDate.getMonth() + 1) + "-" + myDate.getDate();
            var county = "";
            var areadata = Ktw.cookie.AreaTree.Children;
            $.each(areadata, function (i, value) {
                county += value.areaname + ",";
            });
            result = [];
            var y = [{ starttime: starttime, endtime: endtime }];
            if (type == "year") {
                y = [];
                flag = "byyear"
                county = $("#area").prop("$this").GetText();
                var startyear = $("#startyear").prop("$this").GetText();
                var endyear = $("#endyear").prop("$this").GetText();
                if (startyear > endyear) { Ktw.Alert("请选择正确统计时间!"); return; }
                if (validation() == false) return;
                y.push({ starttime: startyear, endtime: endyear });
            }
            else if (type == "area") {
                var countyarea = $("#area").prop("$this").GetText();
                var deadline = countyarea.split("，");
                if (countyarea != "" || $("#starttime").data().combo.previousText != "" || $("#endtime").data().combo.previousText != "") {
                    y = [];
                    county = deadline.toString();
                    starttime = $("#starttime").data().combo.previousText;
                    endtime = $("#endtime").data().combo.previousText;
                    if (starttime > endtime) { Ktw.Alert("请选择正确统计时间!"); return; }
                    y.push({ starttime: starttime, endtime: endtime });
                }
                else {
                    Ktw.Alert("请选择统计时间!");
                    return;
                }
            }
            else if (type == "quarter") {
                y = [];
                var year = [];
                flag = "byquarter"
                county = $("#area").prop("$this").GetText();
                var startyear = $("#startyear").prop("$this").GetText();
                var endyear = $("#endyear").prop("$this").GetText();
                if (startyear > endyear) { Ktw.Alert("请选择正确统计时间!"); return; }
                var quarter = $("#quarter").prop("$this").GetText();
                if (validation() == false) return;
                var quarterline = quarter.split("，");
                for (var i = 0; i < quarterline.length; i++) {
                    switch (quarterline[i]) {
                        case "第一季度":
                            quarterline[i] = { start: "-01-01", end: "-03-31" }
                            break;
                        case "第二季度":
                            quarterline[i] = { start: "-04-01", end: "-06-30" }
                            break;
                        case "第三季度":
                            quarterline[i] = { start: "-07-01", end: "-09-30" }
                            break;
                        case "第四季度":
                            quarterline[i] = { start: "-10-01", end: "-12-31" }
                            break;
                        default:
                            return;
                    }
                }
                for (var i = startyear; i <= endyear; i++) {
                    for (var j = 0; j < quarterline.length; j++) {
                        y.push({ starttime: i + quarterline[j].start, endtime: i + quarterline[j].end });
                    }
                }
            }
            var map = { dt: y, countyarea: county, flag: flag };
            $.ajax({
                type: "POST",
                data: JSON.stringify(map),
                contentType: "application/json",
                url: Ktw.App.ServerUrl + "tdgy/getinfobyghyt",
                beforeSend: function () {
                    ctr.Show();
                },
                complete: function () {
                    ctr.Close();
                },
                success: function (data) {
                    var k = "";
                    //保留4位小数
                    var RegStr = '^[\\+\\-]?\\d+\\.?\\d{0,4}';
                    if (data.success == false) {
                        Ktw.Alert(data.message);
                        return;
                    }
                    var opts = $('#dataModule').datagrid('getColumnFields');
                    //t数组用来装合计数据
                    var t = [];
                    for (var i = 0; i < opts.length; i++) {
                        t[i] = 0;
                    }
                    for (var i = 0; i < data.data.length; i++) {
                        var time = data.data[i].STARTTIME + "至" + data.data[i].ENDTIME;
                        if (type == "year") {
                            time = data.data[i].STARTTIME + "年"
                        }
                        else if (type == "quarter") {
                            var year = data.data[i].ENDTIME.slice(0, 4);
                            var month = data.data[i].ENDTIME.slice(5, 7);
                            switch (month) {
                                case "03":
                                    month = "第一季度";
                                    break;
                                case "06":
                                    month = "第二季度";
                                    break;
                                case "09":
                                    month = "第三季度";
                                    break;
                                case "12":
                                    month = "第四季度";
                                    break;
                            }
                            time = year + month;
                        }
                        var a = { time: time, XZQMC: data.data[i].XZQMC };
                        for (var j = 2; j < opts.length; j++) {
                            var temp = data.data[i][opts[j]];
                            if (parseInt(temp) != temp && temp.toString().split(".")[1].length > 4) temp = parseFloat(temp.toFixed(4));
                            a[opts[j]] = temp;
                            t[j] = t[j] + a[opts[j]];
                        }
                        result.push(a);
                    }
                    var a = { time: "", XZQMC: "合计" };
                    for (var j = 2; j < opts.length; j++) {
                        a[opts[j]] = t[j];
                    }
                    datamodules = [];
                    for (var i = 0; i < result.length; i++) datamodules.push(result[i]);
                    datamodules.push(a);
                    $('#dataModule').datagrid({
                        data: datamodules
                    });
                    result.unshift(a);
                    xarray = [];
                    if (type == "year" || type == "quarter") {
                        for (var i = 1; i < result.length; i++) xarray.push(result[i].time);
                        xarray.unshift("合计");
                    }
                    else {
                        for (var i = 0; i < result.length; i++) xarray.push(result[i].XZQMC);
                    }
                    initCharts();
                },
                error: function (e) {
                    var k = "";
                }
            });
        }
        function exportData(e) {
            if (result.length <= 1) {
                Ktw.Alert("当前无数据,不支持导出");
                return;
            }
            $.ajax({
                type: "POST",
                data: JSON.stringify(datamodules),
                contentType: "application/json",
                url: Ktw.App.ServerUrl + "tdgy/export",
                success: function (e) {
                    if (e.success) {
                        var path = e.data;
                        if (!ktw.IsNull(path)) {
                            var downlaod = Ktw.App.Root + path;
                            window.open(downlaod);
                        }

                    }
                },
                error: function (e) {
                    var k = "";
                    Ktw.Alert("服务请求失败!");
                }
            });
        }
        function initDataGrid() {
            var width = (winWidth * 0.98 - 30) / 18;
            $('#dataModule').datagrid({
                //pagination: true,
                total: 2000,
                pageSize: 10,
                pageList: [10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
                rownumbers: true,
                fit: true,        //自动大小
                fitColumns: false, //自适应列宽
                singleSelect: true,  //是否单选
                idField: 'Project_id',
                time: time,
                columns: [[
                    { field: 'time', title: '统计时间', width: width, align: 'center', rowspan: 2, },
                    { field: 'XZQMC', title: '市县区', width: width, align: 'center', rowspan: 2 },
                    { field: 'mGyMj', title: '供应总面积(公顷)', width: width, rowspan: 2 },
                    { field: 'mJianCount', title: '供应总宗数(个)', width: width, align: 'center', rowspan: 2 },
                     { field: 'mCrjk', title: '供应所得总价款(万元)', width: width, align: 'center', rowspan: 2, },
                     { field: 'mSf', title: '商服用地(公顷)', width: width, align: 'center', rowspan: 2, },
                     { field: 'mGkGyMj', title: '工矿仓储用地(公顷)', width: width, colspan: 2, align: 'center', rowspan: 1 },
                    { field: 'mZzGyMj', title: '住宅用地(公顷)', width: width, colspan: 5, align: 'center', rowspan: 1 },
                    { title: '其他用地(公顷)', width: width, colspan: 5, align: 'center', rowspan: 1 },
                ], [
                    { field: 'mGcc', title: '工业、仓<br/>储用地', width: width, align: 'center', rowspan: 1 },
                     { field: 'mCk', title: '采矿用地', width: width, align: 'center', rowspan: 1 },
                      { field: 'mPtzf', title: '普通商品<br/>住房用地', width: width, align: 'center', rowspan: 1 },
                       { field: 'mJjsyf', title: '经济适<br/>用住房', width: width, align: 'center', colspan: 1, rowspan: 1 },
                       { field: 'mLzzf', title: '廉租住<br/>房用地', width: width, align: 'center', rowspan: 1 },
                       { field: 'mGdzz', title: '高档住<br/>宅用地', width: width, align: 'center', rowspan: 1 },
                       { field: 'mQtzz', title: '其他住<br/>宅用地', width: width, align: 'center', rowspan: 1 },
                       { field: 'mGggf', title: '公共管理<br/>与公共服<br/>务用地', width: width, align: 'center', rowspan: 1 },
                       { field: 'mTsyd', title: '特殊用地', width: width, align: 'center', rowspan: 1 },
                        { field: 'mJtys', title: '交通运<br/>输用地', width: width, align: 'center', rowspan: 1 },
                       { field: 'mSySl', title: '水域及<br/>水利设<br/>施用地', width: width, align: 'center', rowspan: 1 },
                       { field: 'mQtyd', title: '其他用地', width: width, align: 'center', rowspan: 1 },

                ],

                ]
            });
        }
        function initTarget() {
            var areaComBox = $("#area").prop('$this');
            var areadata = Ktw.cookie.AreaTree.Children;
            datas = [];
            $.each(areadata, function (i, value) {
                datas.push(value.areaname);
            });
            areaComBox.SetData(datas);
            $("#area").prop("$this").SetSelectedItem(datas);
            var fieldComBox = $("#field").prop('$this')
            fieldComBox.SetData(["供应总面积", "供应总宗数", "供应所得总价款", "商服用地", "工业仓储用地", "采矿用地", "普通商品住房用地", "经济适用住房", "廉租住房用地", "高档住宅用地", "其他住宅用地", "公共管理与公共服务用地", "特殊用地", "交通运输用地", "水域及水利设施用地", "其他用地"]);
            //fieldComBox.SetData(["供应总面积","供应总宗数","供应所得总价款"])
        }
    </script>
    <style>
        .Content {
            width: 100%;
            height: 100%;
        }

            .Content .ToolDiv {
                width: 100%;
                height: 40px;
                border-bottom: 1px solid #E4E9EF;
            }

                .Content .ToolDiv .Title {
                    width: 85px;
                    text-align: right;
                    line-height: 20px;
                    height: 20px;
                    display: inline-block;
                    float: left;
                }

                    .Content .ToolDiv .Title .Icon {
                        width: 16px;
                        height: 16px;
                        display: inline-block;
                        margin-top: 11px;
                    }

                    .Content .ToolDiv .Title .Text {
                        display: inline-block;
                        float: right;
                        width: 49px;
                    }

            .Content .HiddenBtn {
                filter: alpha(Opacity=80);
                -moz-opacity: 0.8;
                opacity: 0.8;
            }

                .Content .HiddenBtn .ArrowBtn {
                    cursor: pointer;
                }

        .stc-nav {
            /*background-color: pink;*/
            height: 30px;
            padding-top: 4px;
            padding-left: 5px;
            padding-right: 5px;
            /*min-width:500px*/
        }

        .panel-body-noborder {
            border-bottom-width: 1px;
            border-bottom-color: #dddddd;
            border-top-width: 1px;
            border-top-color: #dddddd;
        }

        div#statictable .panel-body-noheader {
            border: 0;
        }

        .Content .ToolDiv .Title .Icon {
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="Content">
        <div class="stc-nav">
            <span class="btng left btng-left active" id="byarea" style="margin-left:0.5%">按行政区</span>
            <span class="btng left" id="byyear">按年份</span>
            <span class="btng left btng-right" id="byquarter">按季度</span>
            <span class="btng right btng-right active" id="map" style="margin-right:1%">图</span>
            <span class="btng right btng-left" id="tab">表</span>
        </div>
        <div id="topport" style="width: 100%;height: 49%;">
            <div id="searchModule" class="ToolDiv" style="position:relative; width:98%;margin-left:1%; margin-top:5px; border-bottom:0px;border:1px solid #CACACA; border-radius:10px;">
                <div id="time" style="display: inline-block;vertical-align: top; margin-top: 10px;margin-left:15px">
                    统计时间：
                    <input id="starttime" name="JSZZRQ" class="easyui-datebox" data-options="width:120,editable:false" /> &nbsp;至：<input id="endtime" name="JSZZRQ" class="easyui-datebox" data-options="width:120,editable:false" />
                </div>
                <div style="display: inline-block;">
                    <div id="startyear" class="ktw-combobox" style="z-index: 4;position:relative; width: 174px; height: 20px;margin-top: 10px;margin-left:5px" opt='{"TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"80px"},"PopupHeight":"85","IsOverShow":true,"Border":"1px","Padding":"0px","TextAlign":"center","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><div class=\"Icon icon-calendar\"></div><span class=\"Text\" style=\"margin-right:10px;\">起始年份</span></div>"}'></div>
                </div>
                <div style="display: inline-block;">
                    <div id="endyear" class="ktw-combobox" style="z-index: 4;position:relative; width: 174px; height: 20px;margin-top: 10px;" opt='{"TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"80px"},"PopupHeight":"85","IsOverShow":true,"Border":"1px","Padding":"0px","TextAlign":"center","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><div class=\"Icon icon-calendar\"></div><span class=\"Text\" style=\"margin-right:10px;\">终止年份</span></div>"}'></div>
                </div>
                <div id="newline1" style="display: inline-block;">
                    <div id="quarter" class="ktw-combobox" style="z-index: 3; position:relative;width: 174px; height: 20px;margin-top: 10px;margin-left:5px" opt='{"TipInfo":"请选择","MultiSelect":true,"HeaderCSS":{"padding":"0px","width":"80px"},"PopupHeight":"85","IsOverShow":true,"Border":"1px","Padding":"1px","TextAlign":"center","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><div class=\"Icon icon-calendar\"></div><span class=\"Text\" style=\"margin-right:10px;\">季度</span></div>"}'></div>
                </div>
                <div id="newline2" style="display: inline-block;">
                    <div id="area" class="ktw-combobox" style="z-index: 3; position:relative;width: 174px; height: 20px;margin-top: 10px;" opt='{"TipInfo":"请选择","MultiSelect":true,"HeaderCSS":{"padding":"0px","width":"80px"},"PopupHeight":"85","IsOverShow":true,"Border":"1px","Padding":"0px","TextAlign":"center","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><div class=\"Icon icon-calendar\"></div><span class=\"Text\" style=\"margin-right:10px;\">县市区</span></div>"}'></div>
                </div>
                <div class="Button" id="export" operatetype="Export" style="float: right; padding-top: 4px; padding-right: 10px; position: absolute">
                    <span class="button">导出</span>
                </div>
                <div class="Button" id="static" operatetype="Statistics" style="float: right; padding-top: 4px; padding-right: 10px; position: absolute;">
                    <span class="button">统计</span>
                </div>
                &nbsp;&nbsp;
                <!--<div style="float: right; margin-right: 10px; margin-top: 15px">单位:宗、公顷、万元</div>-->
            </div>
            <div id="statictable" style="width: 98%; height: calc(100% - 50px); margin: 0 auto; margin-top: 5px; border: 1px solid #CACACA; border-radius: 10px;">
                <div id="dataModule" style="width: 100%;"></div>
            </div>
        </div>
        <div id="chartModule" style="width: 98%; height:calc(49% - 40px); min-height:80px; bottom:0px; margin:0 auto;margin-top:5px;margin-bottom:5px;margin-left:1%; border:1px solid #CACACA; border-radius:10px;">
            <div class="ToolDiv">
                <div style="display: inline-block;margin-left:6px">
                    <div id="field" class="ktw-combobox" style="z-index: 2; width: 174px; height: 20px;margin-top:10px" opt='{"TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"80px"},"PopupHeight":"85","IsOverShow":true,"Border":"1px","Padding":"0px","TextAlign":"center","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><div class=\"Icon icon-calendar\"></div><span class=\"Text\" style=\"margin-right:10px;\">统计字段</span></div>"}'></div>
                </div>
            </div>
            <div id="chart" style="width: 99%; height: calc(100% - 40px); float: left;"></div>
            <!--  <div id="Piechart" style="width: 28%; height: 85%; float: right; border: 1px solid black; margin-right: 5px"></div>-->
        </div>
    </div>
</body>
</html>
